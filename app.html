<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NotFrens - Web3 Platform</title>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&family=Space+Grotesk:wght@300;400;500;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Space Grotesk', sans-serif;
        }

        body {
            background-color: #000;
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            overflow-x: hidden;
        }

        .container {
            width: 100%;
            max-width: 450px;
            min-height: 100vh;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .bg-glow {
            position: absolute;
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: rgba(255, 215, 0, 0.15);
            filter: blur(80px);
            z-index: 0;
        }

        .bg-glow-1 {
            top: 20%;
            left: -100px;
        }

        .bg-glow-2 {
            bottom: 10%;
            right: -50px;
        }

        .api-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(20, 20, 20, 0.9);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 12px;
            z-index: 1000;
            cursor: pointer;
        }

        .api-status.online {
            border-color: #55ff7f;
            color: #55ff7f;
        }

        .api-status.offline {
            border-color: #ff5555;
            color: #ff5555;
        }

        .api-status.testing {
            border-color: #FFD700;
            color: #FFD700;
        }

        .wallet-connect-area {
            width: 100%;
            display: flex;
            justify-content: center;
            margin-top: 20px;
            margin-bottom: 10px;
            position: relative;
            z-index: 3;
        }

        .wallet-info {
            background: rgba(20, 20, 20, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid rgba(0, 152, 234, 0.3);
            box-shadow: 0 0 15px rgba(0, 152, 234, 0.2);
            width: 100%;
            text-align: center;
            display: none;
        }

        .wallet-info.active {
            display: block;
        }

        .wallet-address {
            font-family: 'Orbitron', monospace;
            font-size: 14px;
            color: #0098ea;
            margin: 5px 0;
            word-break: break-all;
            background: rgba(0, 152, 234, 0.1);
            padding: 8px;
            border-radius: 8px;
            border: 1px solid rgba(0, 152, 234, 0.2);
        }

        .wallet-balance {
            font-size: 16px;
            color: #FFD700;
            font-weight: 600;
            margin: 8px 0;
        }

        .logo-container {
            margin-top: 40px;
            margin-bottom: 20px;
            position: relative;
            z-index: 2;
        }

        .logo {
            width: 150px;
            height: 150px;
            position: relative;
        }

        .logo svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.7));
        }

        .logo-path {
            stroke: #FFD700;
            stroke-width: 2;
            fill: none;
            filter: drop-shadow(0 0 3px #FFD700);
        }

        .logo-node {
            fill: #FFD700;
            filter: drop-shadow(0 0 5px #FFD700);
        }

        .token-display {
            margin: 30px 0;
            background: rgba(20, 20, 20, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255, 215, 0, 0.3);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
            width: 100%;
            position: relative;
            z-index: 2;
        }

        .token-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .token-amount {
            font-family: 'Orbitron', sans-serif;
            font-size: 32px;
            font-weight: 700;
            color: #FFD700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .button-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 15px;
            width: 100%;
            margin-top: auto;
            position: relative;
            z-index: 2;
        }

        .nav-button {
            background: rgba(20, 20, 20, 0.8);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 12px;
            padding: 20px 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .nav-button:hover {
            background: rgba(30, 30, 30, 0.9);
            border-color: rgba(255, 215, 0, 0.6);
            transform: translateY(-2px);
        }

        .button-icon {
            font-size: 24px;
            margin-bottom: 8px;
            color: #FFD700;
            position: relative;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .button-label {
            font-size: 14px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
        }

        .coming-soon::before {
            content: "Coming Soon";
            position: absolute;
            top: -8px;
            right: -8px;
            background: #FFD700;
            color: #000;
            font-size: 8px;
            padding: 3px 6px;
            border-radius: 8px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .status-message {
            margin: 15px 0;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-size: 14px;
            display: none;
            width: 100%;
            max-width: 400px;
        }

        .status-message.success {
            background: rgba(39, 174, 96, 0.2);
            color: #2ecc71;
            border: 1px solid rgba(39, 174, 96, 0.3);
        }

        .status-message.error {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            border: 1px solid rgba(231, 76, 60, 0.3);
        }

        .status-message.loading {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
            border: 1px solid rgba(52, 152, 219, 0.3);
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .pulse-animation {
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 10px rgba(255, 215, 0, 0.3); }
            50% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.5); }
            100% { box-shadow: 0 0 10px rgba(255, 215, 0, 0.3); }
        }

        /* MODAL STYLES */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: rgba(20, 20, 20, 0.95);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 15px;
            padding: 25px;
            max-width: 90%;
            width: 400px;
            position: relative;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.2);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 215, 0, 0.2);
            padding-bottom: 10px;
        }

        .modal-title {
            font-family: 'Orbitron', sans-serif;
            color: #FFD700;
            font-size: 18px;
            font-weight: 500;
        }

        .close-modal {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 20px;
            cursor: pointer;
            transition: color 0.3s ease;
            outline: none;
        }

        .close-modal:hover {
            color: #FFD700;
        }

        .payment-amount {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .payment-amount .currency {
            font-size: 24px;
        }

        .payment-amount .amount {
            font-size: 28px;
            font-weight: bold;
            color: #000;
        }

        .payment-amount .description {
            font-size: 16px;
            color: #333;
        }

        .payment-btn {
            width: 100%;
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #000;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .payment-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
        }

        .payment-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* FRENS SCREEN STYLES */
        .frens-screen {
            width: 100%;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            background: #000;
            z-index: 20;
            padding: 20px;
            display: none;
            flex-direction: column;
            overflow-y: auto;
        }

        .screen-header {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 215, 0, 0.2);
            position: relative;
        }

        .screen-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 22px;
            color: #FFD700;
            font-weight: 700;
        }

        .back-button {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.9);
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            position: absolute;
            left: 0;
        }

        .back-icon {
            margin-right: 5px;
            font-size: 14px;
        }

        .back-button:hover {
            color: #FFD700;
        }

        .stats-container {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stats-box {
            flex: 1;
            background: rgba(20, 20, 20, 0.8);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
        }

        .stats-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stats-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 24px;
            font-weight: 700;
            color: #FFD700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .premium-status {
            background: rgba(20, 20, 20, 0.8);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .not-premium .status-text {
            color: #ff5555;
            font-weight: 500;
        }

        .premium .status-text {
            color: #55ff7f;
            font-weight: 500;
        }

        .premium-button {
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid rgba(255, 215, 0, 0.4);
            border-radius: 8px;
            color: #FFD700;
            font-size: 14px;
            padding: 8px 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .premium-button:hover {
            background: rgba(255, 215, 0, 0.3);
            transform: translateY(-2px);
        }

        .referral-link-container {
            background: rgba(20, 20, 20, 0.8);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .link-label {
            font-size: 14px;
            color: #FFD700;
            margin-bottom: 10px;
            text-align: center;
        }

        .link-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .referral-input {
            width: 100%;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            color: #fff;
            font-size: 13px;
            outline: none;
        }

        .link-buttons {
            display: flex;
            gap: 10px;
        }

        .link-button {
            flex: 1;
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid rgba(255, 215, 0, 0.4);
            border-radius: 8px;
            color: #FFD700;
            font-size: 14px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .link-button:hover {
            background: rgba(255, 215, 0, 0.3);
            transform: translateY(-2px);
        }

        .direct-referrals {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 20px;
        }

        .referral-card {
            flex: 1;
            background: rgba(20, 20, 20, 0.8);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 12px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 80px;
        }

        .referral-name {
            font-size: 14px;
            color: #fff;
            margin-bottom: 10px;
            word-break: break-all;
        }

        .referral-status {
            font-size: 12px;
            font-weight: 500;
        }

        .referral-status.added {
            color: #55ff7f;
        }

        .referral-status.not-added {
            color: #ff5555;
        }

        .levels-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
            padding-bottom: 30px;
        }

        .level-card {
            background: rgba(20, 20, 20, 0.8);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            min-height: 70px;
        }

        .level-card.completed {
            border-color: #55ff7f;
            background: rgba(85, 255, 127, 0.1);
        }

        .level-card.locked {
            opacity: 0.6;
        }

        .level-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .level-name {
            font-family: 'Orbitron', sans-serif;
            font-size: 18px;
            color: #FFD700;
            font-weight: 600;
        }

        .level-progress {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }

        .level-rewards {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }

        .reward-amount {
            font-size: 16px;
            font-weight: 600;
            color: #FFD700;
        }

        .claim-button {
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid rgba(255, 215, 0, 0.4);
            border-radius: 8px;
            color: #FFD700;
            font-size: 14px;
            padding: 8px 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .claim-button:hover:not([disabled]) {
            background: rgba(255, 215, 0, 0.3);
            transform: translateY(-2px);
        }

        .claim-button[disabled] {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="api-status" id="apiStatus">API: Checking...</div>
    
    <div class="container" id="mainScreen">
        <div class="bg-glow bg-glow-1"></div>
        <div class="bg-glow bg-glow-2"></div>
        
        <div class="wallet-connect-area">
            <div id="ton-connect-ui"></div>
        </div>
        
        <div class="wallet-info" id="walletInfo">
            <div class="wallet-address" id="walletAddress">Not Connected</div>
            <div class="wallet-balance" id="walletBalance">0 TON</div>
        </div>
        
        <div class="status-message" id="statusMessage"></div>
        
        <div class="logo-container">
            <div class="logo">
                <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <path class="logo-path" d="M50 10 L10 80 L90 80 Z" />
                    <path class="logo-path" d="M50 10 L50 80" />
                    <path class="logo-path" d="M50 10 L10 80" />
                    <path class="logo-path" d="M50 10 L90 80" />
                    <circle class="logo-node" cx="50" cy="10" r="5" />
                    <circle class="logo-node" cx="10" cy="80" r="5" />
                    <circle class="logo-node" cx="90" cy="80" r="5" />
                    <circle class="logo-node" cx="50" cy="80" r="5" />
                </svg>
            </div>
        </div>
        
        <div class="token-display pulse-animation">
            <div class="token-label">Your Matrix Balance</div>
            <div class="token-amount" id="tokenBalance">0 NOTF</div>
        </div>
        
        <div class="button-container">
            <div class="nav-button">
                <div class="button-icon">üèÜ</div>
                <div class="button-label">Rank</div>
            </div>
            
            <div class="nav-button" id="frensButton">
                <div class="button-icon">üë•</div>
                <div class="button-label">Matrix</div>
            </div>
            
            <div class="nav-button">
                <div class="button-icon">‚úÖ</div>
                <div class="button-label">Tasks</div>
            </div>
            
            <div class="nav-button coming-soon">
                <div class="button-icon">üé®</div>
                <div class="button-label">Trade (NFT)</div>
            </div>
        </div>
    </div>

    <!-- PREMIUM PAYMENT MODAL -->
    <div class="modal" id="usdtPaymentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üíé Premium Matrix Access</h3>
                <button class="close-modal" id="closeUsdtModal">√ó</button>
            </div>
            
            <div class="payment-amount">
                <span class="currency">üí∞</span>
                <span class="amount">11 USDT</span>
                <span class="description">Premium Access</span>
            </div>
            
            <div style="margin-bottom: 20px;">
                <h4 style="color: #FFD700; margin-bottom: 10px;">Premium Benefits:</h4>
                <ul style="list-style: none; padding: 0;">
                    <li style="margin: 8px 0; color: #fff;">üîì Unlock 3x3 matrix system</li>
                    <li style="margin: 8px 0; color: #fff;">üí∞ Refer up to 3 members</li>
                    <li style="margin: 8px 0; color: #fff;">üèÜ Earn from matrix levels</li>
                    <li style="margin: 8px 0; color: #fff;">üìä Track your network</li>
                </ul>
            </div>
            
            <button onclick="sendUSDTPayment()" class="payment-btn" id="usdtPayBtn">
                üí∞ Send 11 USDT Payment
            </button>
            
            <div style="margin-top: 15px; padding: 10px; background: rgba(255, 193, 7, 0.1); border-radius: 8px; font-size: 12px; color: rgba(255, 255, 255, 0.8);">
                ‚ö†Ô∏è <strong>Important:</strong> Payment activates your premium matrix immediately.
            </div>
        </div>
    </div>

    <!-- MATRIX SCREEN -->
    <div class="frens-screen" id="frensScreen">
        <div class="screen-header">
            <button class="back-button" id="frensBackButton">
                <span class="back-icon">&#10094;</span> Back
            </button>
            <h2 class="screen-title">Premium Matrix</h2>
        </div>
        
        <div class="stats-container">
            <div class="stats-box">
                <div class="stats-label">Matrix Level</div>
                <div class="stats-value" id="matrixLevel">0</div>
            </div>
            <div class="stats-box">
                <div class="stats-label">Referrals</div>
                <div class="stats-value" id="totalReferrals">0</div>
            </div>
        </div>
        
        <div class="premium-status not-premium" id="premiumStatusDiv">
            <span class="status-text" id="premiumStatusText">Premium Required</span>
            <button class="premium-button" id="premiumButton" onclick="showUSDTPayment()">Pay 11 USDT</button>
        </div>
        
        <div class="referral-link-container" id="referralSection" style="display: none;">
            <div class="link-label">Your Matrix Referral Link</div>
            <div class="link-actions">
                <input type="text" class="referral-input" id="referralInput" value="Loading..." readonly>
                <div class="link-buttons">
                    <button class="link-button" id="copyButton">Copy</button>
                    <button class="link-button" id="shareButton">Share</button>
                </div>
            </div>
        </div>
        
        <div class="direct-referrals" id="directReferrals">
            <div class="referral-card">
                <div class="referral-name">Slot 1</div>
                <div class="referral-status not-added">Empty</div>
            </div>
            <div class="referral-card">
                <div class="referral-name">Slot 2</div>
                <div class="referral-status not-added">Empty</div>
            </div>
            <div class="referral-card">
                <div class="referral-name">Slot 3</div>
                <div class="referral-status not-added">Empty</div>
            </div>
        </div>
        
        <div class="levels-container" id="levelsContainer">
            <!-- Levels will be populated by JavaScript -->
        </div>
    </div>

    <script>
        let tonConnectUI;
        let currentWallet = null;
        let currentUser = null;
        
        // API Configuration
        const API_BASE = 'https://notfrens.app/api';
        
        // USDT Contract Address (TRC20 USDT)
        const USDT_CONTRACT = "TEFccmfQ38cZS1DTZVhsxKVDckA8Y6VfCy";
        const OWNER_ADDRESS = "TBcze1C3woVvPVjvQYGvPGFMj4HgVLLnDL"; // TRON address for USDT
        const USDT_AMOUNT = 11;

        // DOM Elements
        const elements = {
            apiStatus: document.getElementById('apiStatus'),
            walletInfo: document.getElementById('walletInfo'),
            walletAddress: document.getElementById('walletAddress'),
            walletBalance: document.getElementById('walletBalance'),
            statusMessage: document.getElementById('statusMessage'),
            tokenBalance: document.getElementById('tokenBalance'),
            mainScreen: document.getElementById('mainScreen'),
            frensScreen: document.getElementById('frensScreen'),
            frensButton: document.getElementById('frensButton'),
            frensBackButton: document.getElementById('frensBackButton'),
            copyButton: document.getElementById('copyButton'),
            shareButton: document.getElementById('shareButton'),
            referralInput: document.getElementById('referralInput'),
            directReferrals: document.getElementById('directReferrals'),
            premiumStatusDiv: document.getElementById('premiumStatusDiv'),
            premiumStatusText: document.getElementById('premiumStatusText'),
            premiumButton: document.getElementById('premiumButton'),
            referralSection: document.getElementById('referralSection'),
            matrixLevel: document.getElementById('matrixLevel'),
            totalReferrals: document.getElementById('totalReferrals'),
            levelsContainer: document.getElementById('levelsContainer'),
            usdtPaymentModal: document.getElementById('usdtPaymentModal'),
            closeUsdtModal: document.getElementById('closeUsdtModal')
        };

        // API Functions
        async function makeAPIRequest(endpoint, options = {}) {
            const url = `${API_BASE}${endpoint}`;
            console.log('API Request:', url);
            
            try {
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    ...options
                });
                
                const data = await response.json();
                return { success: true, data };
            } catch (error) {
                console.error('API Error:', error);
                return { success: false, error: error.message };
            }
        }

        async function checkApiHealth() {
            elements.apiStatus.textContent = 'API: Testing...';
            elements.apiStatus.className = 'api-status testing';
            
            const result = await makeAPIRequest('/health');
            
            if (result.success) {
                const data = result.data;
                elements.apiStatus.textContent = `API: Online (${data.users || 0} users)`;
                elements.apiStatus.className = 'api-status online';
                return true;
            } else {
                elements.apiStatus.textContent = 'API: Offline';
                elements.apiStatus.className = 'api-status offline';
                return false;
            }
        }

        // TON Connect Integration
        async function initTonConnect() {
            try {
                tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
                    manifestUrl: 'https://notfrens.app/tonconnect-manifest.json',
                    buttonRootId: 'ton-connect-ui'
                });

                tonConnectUI.onStatusChange((wallet) => {
                    if (wallet) {
                        currentWallet = wallet;
                        handleWalletConnected(wallet);
                    } else {
                        currentWallet = null;
                        handleWalletDisconnected();
                    }
                });

                if (tonConnectUI.wallet) {
                    currentWallet = tonConnectUI.wallet;
                    handleWalletConnected(tonConnectUI.wallet);
                }
            } catch (error) {
                showStatus('TON Connect failed to load', 'error');
            }
        }

        async function handleWalletConnected(wallet) {
            elements.walletAddress.textContent = wallet.account.address;
            elements.walletInfo.classList.add('active');
            
            await updateWalletBalance(wallet.account.address);
            showStatus('Wallet connected successfully!', 'success');
            
            // Notify backend
            await makeAPIRequest('/ton/connect', {
                method: 'POST',
                body: JSON.stringify({
                    telegramId: getTelegramUserId(),
                    walletAddress: wallet.account.address
                })
            });
        }

        function handleWalletDisconnected() {
            elements.walletAddress.textContent = 'Not Connected';
            elements.walletBalance.textContent = '0 TON';
            elements.walletInfo.classList.remove('active');
        }

        async function updateWalletBalance(address) {
            try {
                const result = await makeAPIRequest('/ton/balance', {
                    method: 'POST',
                    body: JSON.stringify({ address })
                });

                if (result.success) {
                    elements.walletBalance.textContent = `${result.data.balance} TON`;
                }
            } catch (error) {
                elements.walletBalance.textContent = '0 TON';
            }
        }

        // User Functions
        function getTelegramUserId() {
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe) {
                const user = window.Telegram.WebApp.initDataUnsafe.user;
                if (user && user.id) {
                    return user.id;
                }
            }
            
            const urlParams = new URLSearchParams(window.location.search);
            return parseInt(urlParams.get('user')) || 123456789;
        }

        function getTelegramUserData() {
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe) {
                const user = window.Telegram.WebApp.initDataUnsafe.user;
                if (user) {
                    return {
                        id: user.id,
                        username: user.username || 'User',
                        first_name: user.first_name || 'Unknown',
                        last_name: user.last_name || ''
                    };
                }
            }
            
            return {
                id: 123456789,
                username: 'DemoUser',
                first_name: 'Demo',
                last_name: 'User'
            };
        }

        // Load User Data
        async function loadUserData() {
            try {
                const userId = getTelegramUserId();
                console.log('Loading user data for:', userId);
                
                const result = await makeAPIRequest(`/telegram-user/${userId}`);
                
                if (result.success) {
                    currentUser = result.data.user;
                    updateUserInterface(currentUser);
                    console.log('User data loaded:', currentUser);
                    return true;
                } else {
                    console.error('Failed to load user data:', result.error);
                    loadDemoData();
                    return false;
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                loadDemoData();
                return false;
            }
        }

        function loadDemoData() {
            const userData = getTelegramUserData();
            
            currentUser = {
                telegramId: userData.id,
                username: userData.username,
                firstName: userData.first_name,
                isPremium: false,
                matrix: { level: 0, referrals: [] },
                levels: {},
                directReferrals: [],
                referralLink: `https://t.me/not_frens_bot?start=ref${userData.id}`,
                stats: {
                    totalReferrals: 0,
                    completedLevels: 0
                }
            };
            
            updateUserInterface(currentUser);
        }

        // Update UI
        function updateUserInterface(user) {
            if (!user) return;
            
            // Update token balance (always starts from 0)
            elements.tokenBalance.textContent = '0 NOTF';
            
            // Update premium status
            updatePremiumStatus(user.isPremium);
            
            if (user.isPremium) {
                // Show premium sections
                elements.referralSection.style.display = 'block';
                
                // Update matrix stats
                elements.matrixLevel.textContent = user.matrix?.level || 1;
                elements.totalReferrals.textContent = user.stats?.totalReferrals || 0;
                
                // Update referral link
                elements.referralInput.value = user.referralLink || 'Loading...';
                
                // Update direct referrals
                updateDirectReferrals(user.directReferrals || []);
            } else {
                // Hide premium sections
                elements.referralSection.style.display = 'none';
                
                // Reset stats for non-premium
                elements.matrixLevel.textContent = '0';
                elements.totalReferrals.textContent = '0';
                
                // Show empty referral slots
                updateDirectReferrals([]);
            }
            
            // Update levels
            updateLevels(user.levels || {});
        }

        function updatePremiumStatus(isPremium) {
            if (isPremium) {
                elements.premiumStatusDiv.className = 'premium-status premium';
                elements.premiumStatusText.textContent = 'Premium Active ‚úÖ';
                elements.premiumButton.style.display = 'none';
            } else {
                elements.premiumStatusDiv.className = 'premium-status not-premium';
                elements.premiumStatusText.textContent = 'Premium Required ‚ùå';
                elements.premiumButton.style.display = 'block';
            }
        }

        function updateDirectReferrals(referrals) {
            const slots = elements.directReferrals.children;
            
            for (let i = 0; i < 3; i++) {
                const slot = slots[i];
                const referral = referrals[i];
                
                if (referral) {
                    slot.innerHTML = `
                        <div class="referral-name">@${referral.username}</div>
                        <div class="referral-status added">Premium (+100 NOTF)</div>
                    `;
                } else {
                    slot.innerHTML = `
                        <div class="referral-name">Slot ${i + 1}</div>
                        <div class="referral-status not-added">Empty</div>
                    `;
                }
            }
        }

        function updateLevels(levels) {
            elements.levelsContainer.innerHTML = '';
            
            // Level configuration for 3x3 matrix
            const levelConfig = [
                { level: 1, required: 3, reward: 30 },
                { level: 2, required: 9, reward: 90 },
                { level: 3, required: 27, reward: 270 },
                { level: 4, required: 81, reward: 810 },
                { level: 5, required: 243, reward: 2430 },
                { level: 6, required: 729, reward: 7290 },
                { level: 7, required: 2187, reward: 21870 },
                { level: 8, required: 6561, reward: 65610 },
                { level: 9, required: 19683, reward: 196830 },
                { level: 10, required: 59049, reward: 590490 },
                { level: 11, required: 177147, reward: 1771470 },
                { level: 12, required: 531441, reward: 5314410 }
            ];
            
            levelConfig.forEach(config => {
                const levelData = levels[config.level] || {
                    current: 0,
                    required: config.required,
                    completed: false,
                    reward: config.reward,
                    canClaim: false,
                    locked: !currentUser?.isPremium
                };
                
                const levelCard = document.createElement('div');
                levelCard.className = `level-card ${levelData.completed ? 'completed' : ''} ${levelData.locked ? 'locked' : ''}`;
                
                levelCard.innerHTML = `
                    <div class="level-info">
                        <div class="level-name">Level ${config.level}</div>
                        <div class="level-progress">${levelData.current}/${levelData.required} referrals</div>
                    </div>
                    <div class="level-rewards">
                        <div class="reward-amount">${levelData.reward.toLocaleString()}</div>
                        ${levelData.canClaim ? 
                            `<button class="claim-button" onclick="claimReward(${config.level})">Claim</button>` : 
                            levelData.locked ? 
                                `<button class="claim-button" disabled>Premium Required</button>` :
                                `<button class="claim-button" disabled>Not Complete</button>`
                        }
                    </div>
                `;
                
                elements.levelsContainer.appendChild(levelCard);
            });
        }

        // Payment Functions
        function showUSDTPayment() {
            elements.usdtPaymentModal.style.display = 'flex';
        }

        async function sendUSDTPayment() {
            try {
                const payBtn = document.getElementById('usdtPayBtn');
                payBtn.disabled = true;
                payBtn.textContent = 'Processing...';
                
                showStatus('Opening external USDT payment...', 'loading');
                
                const userId = getTelegramUserId();
                
                // Open USDT payment link (external wallet)
                const paymentUrl = `https://link.trustwallet.com/send?coin=195&address=${OWNER_ADDRESS}&amount=${USDT_AMOUNT}&memo=NotFrens-Premium-${userId}`;
                
                // For mobile, open in external app
                if (window.Telegram && window.Telegram.WebApp) {
                    window.Telegram.WebApp.openLink(paymentUrl);
                } else {
                    window.open(paymentUrl, '_blank');
                }
                
                // Simulate payment completion after user returns
                setTimeout(() => {
                    simulatePaymentCompletion(userId);
                }, 3000);
                
            } catch (error) {
                showStatus('Payment setup failed: ' + error.message, 'error');
            } finally {
                const payBtn = document.getElementById('usdtPayBtn');
                payBtn.disabled = false;
                payBtn.textContent = 'üí∞ Send 11 USDT Payment';
                elements.usdtPaymentModal.style.display = 'none';
            }
        }

        async function simulatePaymentCompletion(userId) {
            try {
                // Notify backend about payment
                const result = await makeAPIRequest('/payment/usdt', {
                    method: 'POST',
                    body: JSON.stringify({
                        telegramId: userId,
                        type: 'usdt_external',
                        hash: `demo_${Date.now()}`,
                        from: 'external_wallet',
                        to: OWNER_ADDRESS,
                        amount: USDT_AMOUNT,
                        comment: `NotFrens Premium - User ${userId}`,
                        usdtEquivalent: USDT_AMOUNT
                    })
                });
                
                if (result.success) {
                    showStatus('üéâ Premium activated! You can now build your matrix!', 'success');
                    
                    // Reload user data
                    setTimeout(() => {
                        loadUserData();
                    }, 2000);
                } else {
                    showStatus('Payment verification failed. Contact support.', 'error');
                }
                
            } catch (error) {
                showStatus('Payment processing error', 'error');
            }
        }

        // Claim Functions
        async function claimReward(level) {
            if (!currentUser) {
                showStatus('Please load user data first!', 'error');
                return;
            }

            if (!currentUser.isPremium) {
                showStatus('Premium required for claiming rewards!', 'error');
                showUSDTPayment();
                return;
            }
            
            const button = event.target;
            const originalText = button.textContent;
            
            button.textContent = 'Claiming...';
            button.disabled = true;

            try {
                const result = await makeAPIRequest('/telegram-claim', {
                    method: 'POST',
                    body: JSON.stringify({
                        telegramId: currentUser.telegramId,
                        level: level
                    })
                });

                if (result.success) {
                    const claimData = result.data.claimRequest;
                    showStatus(`üéâ Claim submitted! Level ${claimData.level}: ${claimData.amount.toLocaleString()}`, 'success');
                    button.textContent = 'Claimed ‚úÖ';
                    button.style.background = 'rgba(85, 255, 127, 0.3)';
                } else {
                    showStatus(`‚ùå Claim failed: ${result.error}`, 'error');
                    button.textContent = originalText;
                    button.disabled = false;
                }
            } catch (error) {
                showStatus('Error processing claim', 'error');
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        // Utility Functions
        function showStatus(message, type) {
            const statusEl = elements.statusMessage;
            statusEl.className = `status-message ${type}`;
            
            if (type === 'loading') {
                statusEl.innerHTML = `<span class="loading-spinner"></span>${message}`;
            } else {
                statusEl.textContent = message;
            }
            
            statusEl.style.display = 'block';

            if (type !== 'loading') {
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 5000);
            }
        }

        // Event Listeners
        function setupEventListeners() {
            // Navigation
            elements.frensButton?.addEventListener('click', function() {
                elements.mainScreen.style.display = 'none';
                elements.frensScreen.style.display = 'flex';
            });
            
            elements.frensBackButton?.addEventListener('click', function() {
                elements.frensScreen.style.display = 'none';
                elements.mainScreen.style.display = 'flex';
            });
            
            // Modal controls
            elements.closeUsdtModal?.addEventListener('click', function() {
                elements.usdtPaymentModal.style.display = 'none';
            });

            window.addEventListener('click', function(event) {
                if (event.target === elements.usdtPaymentModal) {
                    elements.usdtPaymentModal.style.display = 'none';
                }
            });
            
            // Copy referral link
            elements.copyButton?.addEventListener('click', function() {
                const referralLink = elements.referralInput.value;
                
                try {
                    navigator.clipboard.writeText(referralLink);
                    this.textContent = 'Copied!';
                    this.style.background = 'rgba(85, 255, 127, 0.3)';
                    
                    setTimeout(() => {
                        this.textContent = 'Copy';
                        this.style.background = 'rgba(255, 215, 0, 0.2)';
                    }, 2000);
                } catch (err) {
                    // Fallback
                    const textArea = document.createElement('textarea');
                    textArea.value = referralLink;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    
                    this.textContent = 'Copied!';
                    setTimeout(() => {
                        this.textContent = 'Copy';
                    }, 2000);
                }
            });
            
            // Share referral link
            elements.shareButton?.addEventListener('click', function() {
                const referralLink = elements.referralInput.value;
                
                if (navigator.share) {
                    navigator.share({
                        title: 'Join NotFrens Matrix',
                        text: 'Join the premium 3x3 matrix system!',
                        url: referralLink
                    });
                } else {
                    navigator.clipboard.writeText(referralLink);
                    this.textContent = 'Shared!';
                    setTimeout(() => {
                        this.textContent = 'Share';
                    }, 2000);
                }
            });

            // API status click
            elements.apiStatus?.addEventListener('click', function() {
                checkApiHealth();
            });
        }

        // App Initialization
        async function initializeApp() {
            console.log('üöÄ Initializing NotFrens Matrix App...');
            
            setupEventListeners();
            
            // Initialize Telegram WebApp
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
            }
            
            // Check API health
            await checkApiHealth();
            
            // Initialize TON Connect
            await initTonConnect();
            
            // Load user data
            setTimeout(() => {
                loadUserData();
            }, 1000);
            
            console.log('‚úÖ App initialization complete');
        }

        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        // Global functions
        window.showUSDTPayment = showUSDTPayment;
        window.sendUSDTPayment = sendUSDTPayment;
        window.claimReward = claimReward;
        window.loadUserData = loadUserData;
        window.checkApiHealth = checkApiHealth;
    </script>
</body>
</html>
