<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NotFrens Matrix - Premium 3x3 System</title>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&family=Space+Grotesk:wght@300;400;500;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Space Grotesk', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 100%);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            width: 100%;
            max-width: 450px;
            min-height: 100vh;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .api-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(20, 20, 20, 0.9);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 12px;
            z-index: 1000;
            cursor: pointer;
        }

        .api-status.online {
            border-color: #55ff7f;
            color: #55ff7f;
        }

        .api-status.offline {
            border-color: #ff5555;
            color: #ff5555;
        }

        .api-status.testing {
            border-color: #FFD700;
            color: #FFD700;
        }

        .wallet-connect-area {
            width: 100%;
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            z-index: 3;
        }

        .wallet-info {
            background: rgba(20, 20, 40, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid rgba(0, 152, 234, 0.3);
            width: 100%;
            text-align: center;
            display: none;
        }

        .wallet-info.active {
            display: block;
        }

        .wallet-address {
            font-family: 'Orbitron', monospace;
            font-size: 14px;
            color: #0098ea;
            margin: 5px 0;
            word-break: break-all;
            background: rgba(0, 152, 234, 0.1);
            padding: 8px;
            border-radius: 8px;
        }

        .wallet-balance {
            font-size: 16px;
            color: #FFD700;
            font-weight: 600;
        }

        .status-message {
            margin: 15px 0;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-size: 14px;
            display: none;
        }

        .status-message.success {
            background: rgba(39, 174, 96, 0.2);
            color: #2ecc71;
            border: 1px solid rgba(39, 174, 96, 0.3);
        }

        .status-message.error {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            border: 1px solid rgba(231, 76, 60, 0.3);
        }

        .status-message.loading {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
            border: 1px solid rgba(52, 152, 219, 0.3);
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .logo-container {
            text-align: center;
            margin: 20px 0;
        }

        .logo {
            font-family: 'Orbitron', sans-serif;
            font-size: 32px;
            font-weight: 700;
            color: #FFD700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .subtitle {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 5px;
        }

        .premium-status {
            background: rgba(20, 20, 40, 0.8);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .premium-status.active {
            border-color: #55ff7f;
        }

        .premium-status.inactive {
            border-color: #ff5555;
        }

        .status-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .status-text {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .status-description {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 20px;
        }

        .premium-button {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #000;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .premium-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
        }

        .matrix-info {
            background: rgba(20, 20, 40, 0.8);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .matrix-title {
            font-size: 18px;
            font-weight: 600;
            color: #FFD700;
            margin-bottom: 15px;
            text-align: center;
        }

        .matrix-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .stat-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 24px;
            font-weight: 700;
            color: #FFD700;
        }

        .stat-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 5px;
        }

        .referral-section {
            background: rgba(20, 20, 40, 0.8);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .referral-title {
            font-size: 18px;
            font-weight: 600;
            color: #FFD700;
            margin-bottom: 15px;
            text-align: center;
        }

        .referral-code {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 12px;
            color: #fff;
            font-family: 'Orbitron', monospace;
            font-size: 16px;
            text-align: center;
            margin-bottom: 15px;
            word-break: break-all;
        }

        .referral-buttons {
            display: flex;
            gap: 10px;
        }

        .referral-button {
            flex: 1;
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid rgba(255, 215, 0, 0.4);
            border-radius: 8px;
            color: #FFD700;
            font-size: 14px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .referral-button:hover {
            background: rgba(255, 215, 0, 0.3);
            transform: translateY(-2px);
        }

        .matrix-visual {
            background: rgba(20, 20, 40, 0.8);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .matrix-visual-title {
            font-size: 18px;
            font-weight: 600;
            color: #FFD700;
            margin-bottom: 20px;
            text-align: center;
        }

        .matrix-slots {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .matrix-slot {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border: 2px dashed rgba(255, 255, 255, 0.2);
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .matrix-slot.filled {
            border: 2px solid #55ff7f;
            background: rgba(85, 255, 127, 0.1);
        }

        .slot-number {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 5px;
        }

        .slot-username {
            font-size: 14px;
            color: #fff;
            font-weight: 500;
        }

        .slot-empty {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
        }

        .levels-container {
            background: rgba(20, 20, 40, 0.8);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .levels-title {
            font-size: 18px;
            font-weight: 600;
            color: #FFD700;
            margin-bottom: 20px;
            text-align: center;
        }

        .level-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .level-item.completed {
            border: 1px solid #55ff7f;
            background: rgba(85, 255, 127, 0.1);
        }

        .level-item.locked {
            opacity: 0.5;
        }

        .level-info {
            display: flex;
            flex-direction: column;
        }

        .level-name {
            font-family: 'Orbitron', sans-serif;
            font-size: 16px;
            color: #FFD700;
            font-weight: 600;
        }

        .level-progress {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }

        .level-reward {
            text-align: right;
        }

        .reward-amount {
            font-size: 16px;
            font-weight: 600;
            color: #FFD700;
        }

        .claim-button {
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid rgba(255, 215, 0, 0.4);
            border-radius: 6px;
            color: #FFD700;
            font-size: 12px;
            padding: 6px 12px;
            cursor: pointer;
            margin-top: 5px;
        }

        .claim-button:hover:not([disabled]) {
            background: rgba(255, 215, 0, 0.3);
        }

        .claim-button[disabled] {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .navigation {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: auto;
            padding: 20px 0;
        }

        .nav-button {
            background: rgba(20, 20, 40, 0.8);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nav-button:hover {
            border-color: rgba(255, 215, 0, 0.6);
            transform: translateY(-2px);
        }

        .button-icon {
            font-size: 24px;
            margin-bottom: 8px;
            color: #FFD700;
        }

        .button-label {
            font-size: 14px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
        }

        /* MODAL STYLES */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: rgba(20, 20, 40, 0.95);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 15px;
            padding: 25px;
            max-width: 90%;
            width: 400px;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 215, 0, 0.2);
            padding-bottom: 10px;
        }

        .modal-title {
            font-family: 'Orbitron', sans-serif;
            color: #FFD700;
            font-size: 18px;
            font-weight: 500;
        }

        .close-modal {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 20px;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-modal:hover {
            color: #FFD700;
        }

        .payment-amount {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .payment-amount .currency {
            font-size: 24px;
        }

        .payment-amount .amount {
            font-size: 28px;
            font-weight: bold;
            color: #000;
        }

        .payment-btn {
            width: 100%;
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #000;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .payment-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
        }

        .payment-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }

            .matrix-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="api-status" id="apiStatus">API: Checking...</div>
    
    <div class="container">
        <div class="wallet-connect-area">
            <div id="ton-connect-ui"></div>
        </div>
        
        <div class="wallet-info" id="walletInfo">
            <div class="wallet-address" id="walletAddress">Not Connected</div>
            <div class="wallet-balance" id="walletBalance">0 TON</div>
        </div>
        
        <div class="status-message" id="statusMessage"></div>
        
        <div class="logo-container">
            <div class="logo">NotFrens Matrix</div>
            <div class="subtitle">Premium 3x3 Referral System</div>
        </div>
        
        <!-- Premium Status -->
        <div class="premium-status" id="premiumStatus">
            <div class="status-icon" id="statusIcon">❌</div>
            <div class="status-text" id="statusText">Premium Required</div>
            <div class="status-description" id="statusDescription">
                Purchase Premium ($11 USDT) to unlock matrix referral system
            </div>
            <button class="premium-button" id="premiumButton" onclick="showUSDTPayment()">
                💎 Buy Premium - $11 USDT
            </button>
        </div>
        
        <!-- Matrix Info -->
        <div class="matrix-info" id="matrixInfo" style="display: none;">
            <div class="matrix-title">📊 Your Matrix Status</div>
            <div class="matrix-stats">
                <div class="stat-box">
                    <div class="stat-value" id="matrixLevel">0</div>
                    <div class="stat-label">Matrix Level</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="directReferrals">0/3</div>
                    <div class="stat-label">Direct Referrals</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="totalReferrals">0</div>
                    <div class="stat-label">Total Network</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="completedLevels">0/12</div>
                    <div class="stat-label">Levels Complete</div>
                </div>
            </div>
        </div>
        
        <!-- Referral Section -->
        <div class="referral-section" id="referralSection" style="display: none;">
            <div class="referral-title">🔗 Your Referral Link</div>
            <div class="referral-code" id="referralCode">Loading...</div>
            <div class="referral-buttons">
                <button class="referral-button" id="copyButton">📋 Copy</button>
                <button class="referral-button" id="shareButton">📤 Share</button>
            </div>
        </div>
        
        <!-- Matrix Visual -->
        <div class="matrix-visual" id="matrixVisual" style="display: none;">
            <div class="matrix-visual-title">👥 Your Direct Referrals (3x3)</div>
            <div class="matrix-slots" id="matrixSlots">
                <div class="matrix-slot">
                    <div class="slot-number">Slot 1</div>
                    <div class="slot-empty">Empty</div>
                </div>
                <div class="matrix-slot">
                    <div class="slot-number">Slot 2</div>
                    <div class="slot-empty">Empty</div>
                </div>
                <div class="matrix-slot">
                    <div class="slot-number">Slot 3</div>
                    <div class="slot-empty">Empty</div>
                </div>
            </div>
        </div>
        
        <!-- Levels Container -->
        <div class="levels-container">
            <div class="levels-title">🏆 Matrix Levels & Rewards</div>
            <div id="levelsContainer">
                <!-- Levels will be populated by JavaScript -->
            </div>
        </div>
        
        <!-- Navigation -->
        <div class="navigation">
            <div class="nav-button" onclick="window.location.reload()">
                <div class="button-icon">🔄</div>
                <div class="button-label">Refresh</div>
            </div>
            <div class="nav-button" onclick="checkApiHealth()">
                <div class="button-icon">📡</div>
                <div class="button-label">API Status</div>
            </div>
        </div>
    </div>

    <!-- PREMIUM PAYMENT MODAL -->
    <div class="modal" id="usdtPaymentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">💎 Premium Matrix Access</h3>
                <button class="close-modal" id="closeUsdtModal">×</button>
            </div>
            
            <div class="payment-amount">
                <span class="currency">💰</span>
                <span class="amount">11 USDT</span>
            </div>
            
            <div style="margin-bottom: 20px;">
                <h4 style="color: #FFD700; margin-bottom: 10px;">🚀 Premium Benefits:</h4>
                <ul style="list-style: none; padding: 0;">
                    <li style="margin: 8px 0; color: #fff;">🔓 Unlock 3x3 matrix system</li>
                    <li style="margin: 8px 0; color: #fff;">👥 Refer up to 3 premium members</li>
                    <li style="margin: 8px 0; color: #fff;">💰 Earn from 12 matrix levels</li>
                    <li style="margin: 8px 0; color: #fff;">🏆 Claim level rewards</li>
                    <li style="margin: 8px 0; color: #fff;">📊 Matrix analytics & tracking</li>
                </ul>
            </div>
            
            <button onclick="sendUSDTPayment()" class="payment-btn" id="usdtPayBtn">
                💰 Send 11 USDT Payment
            </button>
            
            <div style="margin-top: 15px; padding: 10px; background: rgba(255, 193, 7, 0.1); border-radius: 8px; font-size: 12px; color: rgba(255, 255, 255, 0.8);">
                ⚠️ <strong>Important:</strong> Only premium members can participate in matrix system. Payment activates your matrix immediately.
            </div>
        </div>
    </div>

    <script>
        let tonConnectUI;
        let currentWallet = null;
        let currentUser = null;
        
        // API Configuration
        const API_BASE = 'https://notfrens.app/api';
        const OWNER_USDT_ADDRESS = "UQCpLxU30SVhlQ049kja71GohOM43YR3emTT3igMHsntmlkI";
        const USDT_AMOUNT = 11;

        // DOM Elements
        const elements = {
            apiStatus: document.getElementById('apiStatus'),
            walletInfo: document.getElementById('walletInfo'),
            walletAddress: document.getElementById('walletAddress'),
            walletBalance: document.getElementById('walletBalance'),
            statusMessage: document.getElementById('statusMessage'),
            premiumStatus: document.getElementById('premiumStatus'),
            statusIcon: document.getElementById('statusIcon'),
            statusText: document.getElementById('statusText'),
            statusDescription: document.getElementById('statusDescription'),
            premiumButton: document.getElementById('premiumButton'),
            matrixInfo: document.getElementById('matrixInfo'),
            matrixLevel: document.getElementById('matrixLevel'),
            directReferrals: document.getElementById('directReferrals'),
            totalReferrals: document.getElementById('totalReferrals'),
            completedLevels: document.getElementById('completedLevels'),
            referralSection: document.getElementById('referralSection'),
            referralCode: document.getElementById('referralCode'),
            copyButton: document.getElementById('copyButton'),
            shareButton: document.getElementById('shareButton'),
            matrixVisual: document.getElementById('matrixVisual'),
            matrixSlots: document.getElementById('matrixSlots'),
            levelsContainer: document.getElementById('levelsContainer'),
            usdtPaymentModal: document.getElementById('usdtPaymentModal'),
            closeUsdtModal: document.getElementById('closeUsdtModal')
        };

        // API Functions
        async function makeAPIRequest(endpoint, options = {}) {
            const url = `${API_BASE}${endpoint}`;
            console.log('API Request:', url);
            
            try {
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    ...options
                });
                
                const data = await response.json();
                return { success: true, data };
            } catch (error) {
                console.error('API Error:', error);
                return { success: false, error: error.message };
            }
        }

        async function checkApiHealth() {
            elements.apiStatus.textContent = 'API: Testing...';
            elements.apiStatus.className = 'api-status testing';
            
            const result = await makeAPIRequest('/health');
            
            if (result.success) {
                const data = result.data;
                elements.apiStatus.textContent = `API: Online (${data.users || 0} users, ${data.premiumUsers || 0} premium)`;
                elements.apiStatus.className = 'api-status online';
                return true;
            } else {
                elements.apiStatus.textContent = 'API: Offline';
                elements.apiStatus.className = 'api-status offline';
                return false;
            }
        }

        // TON Connect Integration
        async function initTonConnect() {
            try {
                tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
                    manifestUrl: 'https://notfrens.app/tonconnect-manifest.json',
                    buttonRootId: 'ton-connect-ui'
                });

                tonConnectUI.onStatusChange((wallet) => {
                    if (wallet) {
                        currentWallet = wallet;
                        handleWalletConnected(wallet);
                    } else {
                        currentWallet = null;
                        handleWalletDisconnected();
                    }
                });

                if (tonConnectUI.wallet) {
                    currentWallet = tonConnectUI.wallet;
                    handleWalletConnected(tonConnectUI.wallet);
                }
            } catch (error) {
                showStatus('TON Connect failed to load', 'error');
            }
        }

        async function handleWalletConnected(wallet) {
            elements.walletAddress.textContent = wallet.account.address;
            elements.walletInfo.classList.add('active');
            
            await updateWalletBalance(wallet.account.address);
            showStatus('Wallet connected successfully!', 'success');
            
            // Notify backend
            await makeAPIRequest('/ton/connect', {
                method: 'POST',
                body: JSON.stringify({
                    telegramId: getTelegramUserId(),
                    walletAddress: wallet.account.address
                })
            });
        }

        function handleWalletDisconnected() {
            elements.walletAddress.textContent = 'Not Connected';
            elements.walletBalance.textContent = '0 TON';
            elements.walletInfo.classList.remove('active');
        }

        async function updateWalletBalance(address) {
            try {
                const result = await makeAPIRequest('/ton/balance', {
                    method: 'POST',
                    body: JSON.stringify({ address })
                });

                if (result.success) {
                    elements.walletBalance.textContent = `${result.data.balance} TON`;
                }
            } catch (error) {
                elements.walletBalance.textContent = '0 TON';
            }
        }

        // User Functions
        function getTelegramUserId() {
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe) {
                const user = window.Telegram.WebApp.initDataUnsafe.user;
                if (user && user.id) {
                    return user.id;
                }
            }
            
            const urlParams = new URLSearchParams(window.location.search);
            return parseInt(urlParams.get('user')) || 123456789;
        }

        function getTelegramUserData() {
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe) {
                const user = window.Telegram.WebApp.initDataUnsafe.user;
                if (user) {
                    return {
                        id: user.id,
                        username: user.username || 'User',
                        first_name: user.first_name || 'Unknown',
                        last_name: user.last_name || ''
                    };
                }
            }
            
            return {
                id: 123456789,
                username: 'DemoUser',
                first_name: 'Demo',
                last_name: 'User'
            };
        }

        // Load User Data
        async function loadUserData() {
            try {
                const userId = getTelegramUserId();
                console.log('Loading user data for:', userId);
                
                const result = await makeAPIRequest(`/telegram-user/${userId}`);
                
                if (result.success) {
                    currentUser = result.data.user;
                    updateUserInterface(currentUser);
                    console.log('User data loaded:', currentUser);
                    return true;
                } else {
                    console.error('Failed to load user data:', result.error);
                    showStatus('Failed to load user data', 'error');
                    return false;
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                showStatus('Error loading user data', 'error');
                return false;
            }
        }

        // Update UI
        function updateUserInterface(user) {
            if (!user) return;
            
            // Update premium status
            updatePremiumStatus(user.isPremium);
            
            if (user.isPremium) {
                // Show matrix info
                elements.matrixInfo.style.display = 'block';
                elements.referralSection.style.display = 'block';
                elements.matrixVisual.style.display = 'block';
                
                // Update matrix stats
                elements.matrixLevel.textContent = user.matrix?.level || 1;
                elements.directReferrals.textContent = `${user.totalDirectReferrals || 0}/3`;
                elements.totalReferrals.textContent = user.stats?.totalReferrals || 0;
                elements.completedLevels.textContent = `${user.stats?.completedLevels || 0}/12`;
                
                // Update referral link
                elements.referralCode.textContent = user.referralLink || 'Loading...';
                
                // Update matrix visual
                updateMatrixVisual(user.directReferrals || []);
                
                // Update levels
                updateLevels(user.levels || {});
            } else {
                // Hide premium-only sections
                elements.matrixInfo.style.display = 'none';
                elements.referralSection.style.display = 'none';
                elements.matrixVisual.style.display = 'none';
                
                // Show basic levels (locked)
                updateLevels(user.levels || {});
            }
        }

        function updatePremiumStatus(isPremium) {
            if (isPremium) {
                elements.premiumStatus.className = 'premium-status active';
                elements.statusIcon.textContent = '✅';
                elements.statusText.textContent = 'Premium Active';
                elements.statusDescription.textContent = 'You can now build your 3x3 matrix and refer premium members!';
                elements.premiumButton.style.display = 'none';
            } else {
                elements.premiumStatus.className = 'premium-status inactive';
                elements.statusIcon.textContent = '❌';
                elements.statusText.textContent = 'Premium Required';
                elements.statusDescription.textContent = 'Purchase Premium ($11 USDT) to unlock matrix referral system';
                elements.premiumButton.style.display = 'block';
            }
        }

        function updateMatrixVisual(referrals) {
            const slots = elements.matrixSlots.children;
            
            for (let i = 0; i < 3; i++) {
                const slot = slots[i];
                const referral = referrals[i];
                
                if (referral) {
                    slot.className = 'matrix-slot filled';
                    slot.innerHTML = `
                        <div class="slot-number">Slot ${i + 1}</div>
                        <div class="slot-username">@${referral.username}</div>
                    `;
                } else {
                    slot.className = 'matrix-slot';
                    slot.innerHTML = `
                        <div class="slot-number">Slot ${i + 1}</div>
                        <div class="slot-empty">Empty</div>
                    `;
                }
            }
        }

        function updateLevels(levels) {
            elements.levelsContainer.innerHTML = '';
            
            for (let level = 1; level <= 12; level++) {
                const levelData = levels[level] || {
                    current: 0,
                    required: Math.pow(3, level),
                    completed: false,
                    reward: Math.pow(3, level) * 10,
                    canClaim: false,
                    locked: !currentUser?.isPremium
                };
                
                const levelItem = document.createElement('div');
                levelItem.className = `level-item ${levelData.completed ? 'completed' : ''} ${levelData.locked ? 'locked' : ''}`;
                
                levelItem.innerHTML = `
                    <div class="level-info">
                        <div class="level-name">Level ${level}</div>
                        <div class="level-progress">${levelData.current}/${levelData.required} referrals</div>
                    </div>
                    <div class="level-reward">
                        <div class="reward-amount">${levelData.reward.toLocaleString()}</div>
                        ${levelData.canClaim ? 
                            `<button class="claim-button" onclick="claimReward(${level})">Claim</button>` : 
                            levelData.locked ? 
                                `<button class="claim-button" disabled>Premium Required</button>` :
                                `<button class="claim-button" disabled>Not Complete</button>`
                        }
                    </div>
                `;
                
                elements.levelsContainer.appendChild(levelItem);
            }
        }

        // Payment Functions
        function showUSDTPayment() {
            if (!currentWallet) {
                showStatus('Please connect your TON wallet first!', 'error');
                return;
            }
            
            elements.usdtPaymentModal.style.display = 'flex';
        }

        async function sendUSDTPayment() {
            if (!currentWallet) {
                showStatus('Wallet not connected!', 'error');
                return;
            }
            
            try {
                const payBtn = document.getElementById('usdtPayBtn');
                payBtn.disabled = true;
                payBtn.textContent = 'Processing...';
                
                showStatus('Preparing USDT payment...', 'loading');
                
                const userId = getTelegramUserId();
                const comment = `NotFrens Matrix Premium - User ID: ${userId}`;
                
                const transaction = {
                    validUntil: Math.floor(Date.now() / 1000) + 600,
                    messages: [{
                        address: OWNER_USDT_ADDRESS,
                        amount: (USDT_AMOUNT * 1000000).toString(),
                        payload: btoa(comment)
                    }]
                };
                
                const result = await tonConnectUI.sendTransaction(transaction);
                
                showStatus('Payment sent! Activating premium...', 'success');
                
                // Notify backend
                await makeAPIRequest('/payment/usdt', {
                    method: 'POST',
                    body: JSON.stringify({
                        telegramId: userId,
                        type: 'premium_purchase',
                        hash: result.boc,
                        from: currentWallet.account.address,
                        to: OWNER_USDT_ADDRESS,
                        amount: USDT_AMOUNT,
                        comment: comment,
                        usdtEquivalent: USDT_AMOUNT
                    })
                });
                
                elements.usdtPaymentModal.style.display = 'none';
                
                setTimeout(() => {
                    showStatus('🎉 Premium activated! You can now build your matrix!', 'success');
                    loadUserData(); // Reload user data
                }, 2000);
                
            } catch (error) {
                showStatus('Payment failed: ' + error.message, 'error');
            } finally {
                const payBtn = document.getElementById('usdtPayBtn');
                payBtn.disabled = false;
                payBtn.textContent = '💰 Send 11 USDT Payment';
            }
        }

        // Claim Functions
        async function claimReward(level) {
            if (!currentUser) {
                showStatus('Please load user data first!', 'error');
                return;
            }

            if (!currentUser.isPremium) {
                showStatus('Premium required for claiming rewards!', 'error');
                showUSDTPayment();
                return;
            }
            
            const button = event.target;
            const originalText = button.textContent;
            
            button.textContent = 'Claiming...';
            button.disabled = true;

            try {
                const result = await makeAPIRequest('/telegram-claim', {
                    method: 'POST',
                    body: JSON.stringify({
                        telegramId: currentUser.telegramId,
                        level: level
                    })
                });

                if (result.success) {
                    const claimData = result.data.claimRequest;
                    showStatus(`🎉 Claim submitted! Level ${claimData.level}: ${claimData.amount.toLocaleString()}`, 'success');
                    button.textContent = 'Claimed ✅';
                    button.style.background = 'rgba(85, 255, 127, 0.3)';
                    button.style.borderColor = 'rgba(85, 255, 127, 0.6)';
                } else {
                    showStatus(`❌ Claim failed: ${result.error}`, 'error');
                    button.textContent = originalText;
                    button.disabled = false;
                }
            } catch (error) {
                showStatus('Error processing claim', 'error');
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        // Utility Functions
        function showStatus(message, type) {
            const statusEl = elements.statusMessage;
            statusEl.className = `status-message ${type}`;
            
            if (type === 'loading') {
                statusEl.innerHTML = `<span class="loading-spinner"></span>${message}`;
            } else {
                statusEl.textContent = message;
            }
            
            statusEl.style.display = 'block';

            if (type !== 'loading') {
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 5000);
            }
        }

        // Event Listeners
        function setupEventListeners() {
            // Close modal
            elements.closeUsdtModal?.addEventListener('click', function() {
                elements.usdtPaymentModal.style.display = 'none';
            });

            // Close modal on outside click
            window.addEventListener('click', function(event) {
                if (event.target === elements.usdtPaymentModal) {
                    elements.usdtPaymentModal.style.display = 'none';
                }
            });
            
            // Copy referral link
            elements.copyButton?.addEventListener('click', function() {
                const referralCode = elements.referralCode.textContent;
                
                try {
                    navigator.clipboard.writeText(referralCode);
                    this.textContent = '✅ Copied!';
                    this.style.background = 'rgba(85, 255, 127, 0.3)';
                    
                    setTimeout(() => {
                        this.textContent = '📋 Copy';
                        this.style.background = 'rgba(255, 215, 0, 0.2)';
                    }, 2000);
                } catch (err) {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = referralCode;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    
                    this.textContent = '✅ Copied!';
                    setTimeout(() => {
                        this.textContent = '📋 Copy';
                    }, 2000);
                }
            });
            
            // Share referral link
            elements.shareButton?.addEventListener('click', function() {
                const referralLink = elements.referralCode.textContent;
                
                if (navigator.share) {
                    navigator.share({
                        title: 'Join NotFrens Matrix',
                        text: 'Join the premium 3x3 matrix system and earn together!',
                        url: referralLink
                    });
                } else {
                    navigator.clipboard.writeText(referralLink);
                    this.textContent = '✅ Shared!';
                    this.style.background = 'rgba(85, 255, 127, 0.3)';
                    
                    setTimeout(() => {
                        this.textContent = '📤 Share';
                        this.style.background = 'rgba(255, 215, 0, 0.2)';
                    }, 2000);
                }
            });

            // API status click
            elements.apiStatus?.addEventListener('click', function() {
                checkApiHealth();
            });
        }

        // App Initialization
        async function initializeApp() {
            console.log('🚀 Initializing NotFrens Matrix App...');
            
            setupEventListeners();
            
            // Initialize Telegram WebApp
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
                
                const telegramUser = getTelegramUserData();
                console.log('Telegram User:', telegramUser);
            }
            
            // Check API health
            const apiHealthy = await checkApiHealth();
            
            if (apiHealthy) {
                console.log('✅ API is healthy');
            } else {
                console.log('⚠️ API health check failed');
            }
            
            // Initialize TON Connect
            await initTonConnect();
            
            // Load user data
            setTimeout(() => {
                loadUserData();
            }, 1000);
            
            console.log('✅ App initialization complete');
        }

        // Error handling
        window.addEventListener('error', function(event) {
            console.error('Global error:', event.error);
            showStatus('An error occurred. Please refresh the page.', 'error');
        });

        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        // Global functions
        window.showUSDTPayment = showUSDTPayment;
        window.sendUSDTPayment = sendUSDTPayment;
        window.claimReward = claimReward;
        window.loadUserData = loadUserData;
        window.checkApiHealth = checkApiHealth;
        
        // Debug function
        window.debugInfo = function() {
            return {
                currentUser,
                currentWallet,
                API_BASE,
                apiStatus: elements.apiStatus.textContent
            };
        };
    </script>
</body>
</html><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-
